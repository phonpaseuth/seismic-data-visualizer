(function(q,u,h){"undefined"!==typeof module&&module.exports?module.exports=h():"function"===typeof define&&define.amd?define(h):u[q]=h()})("h337",this,function(){var q={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{"0.25":"rgb(0,0,255)","0.55":"rgb(0,255,0)","0.85":"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},u=function(){var d=function(b){this._coordinator={};this._data=
[];this._radi=[];this._min=0;this._max=1;this._xField=b.xField||b.defaultXField;this._yField=b.yField||b.defaultYField;this._valueField=b.valueField||b.defaultValueField;b.radius&&(this._cfgRadius=b.radius)},r=q.defaultRadius;d.prototype={_organiseData:function(b,a){var c=b[this._xField],f=b[this._yField],e=this._radi,g=this._data,n=this._max,t=this._min,k=b[this._valueField]||1,l=b.radius||this._cfgRadius||r;g[c]||(g[c]=[],e[c]=[]);g[c][f]?g[c][f]+=k:(g[c][f]=k,e[c][f]=l);return g[c][f]>n?(a?this.setDataMax(g[c][f]):
this._max=g[c][f],!1):{x:c,y:f,value:k,radius:l,min:t,max:n}},_unOrganizeData:function(){var b=[],a=this._data,c=this._radi,f;for(f in a)for(var e in a[f])b.push({x:f,y:e,radius:c[f][e],value:a[f][e]});return{min:this._min,max:this._max,data:b}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(b){if(0<b.length)for(var a=b.length;a--;)this.addData.call(this,b[a]);else(b=this._organiseData(b,!0))&&this._coordinator.emit("renderpartial",
{min:this._min,max:this._max,data:[b]});return this},setData:function(b){var a=b.data,c=a.length;this._data=[];this._radi=[];for(var f=0;f<c;f++)this._organiseData(a[f],!1);this._max=b.max;this._min=b.min||0;this._onExtremaChange();this._coordinator.emit("renderall",this._getInternalData());return this},removeData:function(){},setDataMax:function(b){this._max=b;this._onExtremaChange();this._coordinator.emit("renderall",this._getInternalData());return this},setDataMin:function(b){this._min=b;this._onExtremaChange();
this._coordinator.emit("renderall",this._getInternalData());return this},setCoordinator:function(b){this._coordinator=b},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()},getValueAt:function(b){var a=b.x;b=b.y;var c=this._data;if(c[a]&&c[a][b])return c[a][b];for(var f=[],e=1;100>e;e++)for(var g=2*e+1,n=a-e,t=b-e,k=0;k<g;k++)for(var l=0;l<g;l++)(0==k||k==g-1||0==l||l==g-1)&&c[t+k]&&c[t+k][n+l]&&f.push(c[t+
k][n+l]);return 0<f.length?Math.max.apply(Math,f):!1}};return d}(),h=function(){function d(a){var c=a.container,f=this.shadowCanvas=document.createElement("canvas"),b=this.canvas=a.canvas||document.createElement("canvas");this._renderBoundaries=[1E4,1E4,0,0];var g=getComputedStyle(a.container)||{};b.className="heatmap-canvas";this._width=b.width=f.width=+g.width.replace(/px/,"");this._height=b.height=f.height=+g.height.replace(/px/,"");this.shadowCtx=f.getContext("2d");this.ctx=b.getContext("2d");
b.style.cssText=f.style.cssText="position:absolute;left:0;top:0;";c.style.position="relative";c.appendChild(b);this._palette=r(a);this._templates={};this._setStyles(a)}var r=function(a){a=a.gradient||a.defaultGradient;var c=document.createElement("canvas"),b=c.getContext("2d");c.width=256;c.height=1;var c=b.createLinearGradient(0,0,256,1),e;for(e in a)c.addColorStop(e,a[e]);b.fillStyle=c;b.fillRect(0,0,256,1);return b.getImageData(0,0,256,1).data},b=function(a){var c=[],b=a.min,e=a.max,g=a.radi;a=
a.data;for(var n=Object.keys(a),t=n.length;t--;)for(var k=n[t],l=Object.keys(a[k]),d=l.length;d--;){var m=l[d];c.push({x:k,y:m,value:a[k][m],radius:g[k][m]})}return{min:b,max:e,data:c}};d.prototype={renderPartial:function(a){this._drawAlpha(a);this._colorize()},renderAll:function(a){this._clear();this._drawAlpha(b(a));this._colorize()},_updateGradient:function(a){this._palette=r(a)},updateConfig:function(a){a.gradient&&this._updateGradient(a);this._setStyles(a)},setDimensions:function(a,c){this._width=
a;this._height=c;this.canvas.width=this.shadowCanvas.width=a;this.canvas.height=this.shadowCanvas.height=c},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height);this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(a){this._blur=0==a.blur?0:a.blur||a.defaultBlur;a.backgroundColor&&(this.canvas.style.backgroundColor=a.backgroundColor);this._opacity=255*(a.opacity||0);this._maxOpacity=255*(a.maxOpacity||a.defaultMaxOpacity);this._minOpacity=255*(a.minOpacity||a.defaultMinOpacity);
this._useGradientOpacity=!!a.useGradientOpacity},_drawAlpha:function(a){var c=this._min=a.min,b=this._max=a.max;a=a.data||[];for(var e=a.length,g=1-this._blur;e--;){var n=a[e],d=n.x,k=n.y,l=n.radius,n=Math.min(n.value,b),d=d-l,k=k-l,r=this.shadowCtx,m;if(this._templates[l])m=this._templates[l];else{m=this._templates;var q=l,p=l,w=g,h=document.createElement("canvas"),v=h.getContext("2d"),u=p,x=p;h.width=h.height=2*p;1==w?(v.beginPath(),v.arc(u,x,p,0,2*Math.PI,!1),v.fillStyle="rgba(0,0,0,1)",v.fill()):
(w=v.createRadialGradient(u,x,p*w,u,x,p),w.addColorStop(0,"rgba(0,0,0,1)"),w.addColorStop(1,"rgba(0,0,0,0)"),v.fillStyle=w,v.fillRect(0,0,2*p,2*p));m[q]=m=h}r.globalAlpha=(n-c)/(b-c);r.drawImage(m,d,k);d<this._renderBoundaries[0]&&(this._renderBoundaries[0]=d);k<this._renderBoundaries[1]&&(this._renderBoundaries[1]=k);d+2*l>this._renderBoundaries[2]&&(this._renderBoundaries[2]=d+2*l);k+2*l>this._renderBoundaries[3]&&(this._renderBoundaries[3]=k+2*l)}},_colorize:function(){var a=this._renderBoundaries[0],
c=this._renderBoundaries[1],b=this._renderBoundaries[2]-a,e=this._renderBoundaries[3]-c,g=this._width,d=this._height,r=this._opacity,k=this._maxOpacity,l=this._minOpacity,q=this._useGradientOpacity;0>a&&(a=0);0>c&&(c=0);a+b>g&&(b=g-a);c+e>d&&(e=d-c);for(var b=this.shadowCtx.getImageData(a,c,b,e),e=b.data,g=e.length,d=this._palette,m=3;m<g;m+=4){var h=e[m],p=4*h;p&&(h=0<r?r:h<k?h<l?l:h:k,e[m-3]=d[p],e[m-2]=d[p+1],e[m-1]=d[p+2],e[m]=q?d[p+3]:h)}b.data=e;this.ctx.putImageData(b,a,c);this._renderBoundaries=
[1E3,1E3,0,0]},getValueAt:function(a){a=this.shadowCtx.getImageData(a.x,a.y,1,1).data[3];return Math.abs(this._max-this._min)*(a/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}};return d}(),z=function(){var d=!1;"canvas2d"===q.defaultRenderer&&(d=h);return d}(),y={merge:function(){for(var d={},h=arguments.length,b=0;b<h;b++){var a=arguments[b],c;for(c in a)d[c]=a[c]}return d}},A=function(){function d(a){a=this._config=y.merge(q,a||{});this._coordinator=new h;if(a.plugin){var c=a.plugin;
if(q.plugins[c])c=q.plugins[c],this._renderer=new c.renderer(a),this._store=new c.store(a);else throw Error("Plugin '"+c+"' not found. Maybe it was not registered.");}else this._renderer=new z(a),this._store=new u(a);b(this)}var h=function(){function a(){this.cStore={}}a.prototype={on:function(a,b,e){var d=this.cStore;d[a]||(d[a]=[]);d[a].push(function(a){return b.call(e,a)})},emit:function(a,b){var d=this.cStore;if(d[a])for(var g=d[a].length,h=0;h<g;h++)(0,d[a][h])(b)}};return a}(),b=function(a){var b=
a._renderer,d=a._coordinator,e=a._store;d.on("renderpartial",b.renderPartial,b);d.on("renderall",b.renderAll,b);d.on("extremachange",function(b){a._config.onExtremaChange&&a._config.onExtremaChange({min:b.min,max:b.max,gradient:a._config.gradient||a._config.defaultGradient})});e.setCoordinator(d)};d.prototype={addData:function(){this._store.addData.apply(this._store,arguments);return this},removeData:function(){this._store.removeData&&this._store.removeData.apply(this._store,arguments);return this},
setData:function(){this._store.setData.apply(this._store,arguments);return this},setDataMax:function(){this._store.setDataMax.apply(this._store,arguments);return this},setDataMin:function(){this._store.setDataMin.apply(this._store,arguments);return this},configure:function(a){this._config=y.merge(this._config,a);this._renderer.updateConfig(this._config);this._coordinator.emit("renderall",this._store._getInternalData());return this},repaint:function(){this._coordinator.emit("renderall",this._store._getInternalData());
return this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(a){return this._store.getValueAt?this._store.getValueAt(a):this._renderer.getValueAt?this._renderer.getValueAt(a):null}};return d}();return{create:function(d){return new A(d)},register:function(d,h){q.plugins[d]=h}}});